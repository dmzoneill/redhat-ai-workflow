name: review_pr_multiagent
description: 'Multi-agent code review system that coordinates specialized reviewers:


  **Review Agents (Hybrid Claude + Gemini):**

  - üèóÔ∏è **Architecture Agent** (Claude): Design patterns, SOLID principles, architectural
  decisions

  - üîí **Security Agent** (Gemini): Security vulnerabilities, auth issues, data validation

  - ‚ö° **Performance Agent** (Claude): Performance bottlenecks, inefficient algorithms,
  resource usage

  - üß™ **Testing Agent** (Gemini): Test coverage, test quality, edge cases

  - üìù **Documentation Agent** (Claude): Code comments, API docs, README updates

  - üé® **Style Agent** (Gemini): Code style, naming conventions, formatting


  **Coordinator**: Synthesizes all reviews into comprehensive feedback


  Uses Claude + Gemini CLI with Vertex AI - no API keys required!

  '
version: '2.0'
inputs:
- name: mr_id
  type: integer
  required: true
  description: GitLab MR ID (e.g., 1483)
- name: agents
  type: string
  required: false
  default: architecture,security,performance,testing,documentation,style
  description: Comma-separated list of agents
- name: post_combined
  type: boolean
  required: false
  default: true
  description: Post review to MR
- name: debug
  type: boolean
  required: false
  default: false
  description: Debug mode - shows full review output without posting
- name: model
  type: string
  required: false
  default: sonnet
  description: Model to use
outputs:
- name: summary
  description: Summary of the review
- name: review
  description: Combined review text
- name: stats
  description: Review statistics
steps:
- name: get_mr_details
  description: Get MR details
  tool: gitlab_mr_view
  args:
    project: automation-analytics/automation-analytics-backend
    mr_id: '{{ inputs.mr_id }}'
  output: mr_details
- name: get_mr_diff
  description: Get MR diff
  tool: gitlab_mr_diff
  args:
    project: automation-analytics/automation-analytics-backend
    mr_id: '{{ inputs.mr_id }}'
  output: mr_diff
- name: parse_agents
  description: Parse enabled agents
  compute: "agents_str = inputs.get(\"agents\", \"architecture,security\")\nenabled\
    \ = [a.strip() for a in agents_str.split(\",\") if a.strip()]\n\nconfigs = {\n\
    \    \"architecture\": {\"name\": \"Architecture\", \"icon\": \"\U0001F3D7Ô∏è\"\
    , \"cli\": \"claude\"},\n    \"security\": {\"name\": \"Security\", \"icon\":\
    \ \"\U0001F512\", \"cli\": \"gemini\"},\n    \"performance\": {\"name\": \"Performance\"\
    , \"icon\": \"‚ö°\", \"cli\": \"claude\"},\n    \"testing\": {\"name\": \"Testing\"\
    , \"icon\": \"\U0001F9EA\", \"cli\": \"gemini\"},\n    \"documentation\": {\"\
    name\": \"Documentation\", \"icon\": \"\U0001F4DD\", \"cli\": \"claude\"},\n \
    \   \"style\": {\"name\": \"Style\", \"icon\": \"\U0001F3A8\", \"cli\": \"gemini\"\
    }\n}\n\nresult = {\"enabled\": enabled, \"configs\": {k: configs[k] for k in enabled\
    \ if k in configs}}\n"
  output: agents_config
- name: run_all_agents_parallel
  description: Run all agents in parallel
  compute: "import subprocess\nimport threading\nfrom queue import Queue\n\ndef run_agent(agent_name,\
    \ config, mr_details, mr_diff, model):\n    \"\"\"Run a single agent review\"\
    \"\"\n    prompts = {\n        \"architecture\": \"Review this MR for architecture\
    \ issues.\",\n        \"security\": \"Review this MR for security issues.\",\n\
    \        \"performance\": \"Review this MR for performance issues.\",\n      \
    \  \"testing\": \"Review this MR for testing issues.\",\n        \"documentation\"\
    : \"Review this MR for documentation issues.\",\n        \"style\": \"Review this\
    \ MR for code style issues.\"\n    }\n    \n    prompt_text = f\"\"\"{prompts.get(agent_name,\
    \ 'Review this MR.')}\n\nMR: {mr_details}\n\nDiff (first 3000 chars):\n{str(mr_diff)[:3000]}\n\
    \nProvide findings as:\n[CRITICAL] issue\n[WARNING] issue\n[SUGGESTION] issue\n\
    \"\"\"\n    \n    try:\n        proc = subprocess.run(\n            [config[\"\
    cli\"], \"--model\", model],\n            input=prompt_text,\n            capture_output=True,\n\
    \            text=True,\n            timeout=300\n        )\n        return {\n\
    \            \"agent\": agent_name,\n            \"cli\": config[\"cli\"],\n \
    \           \"review\": proc.stdout,\n            \"stderr\": proc.stderr,\n  \
    \          \"returncode\": proc.returncode\n        }\n    except Exception as\
    \ e:\n        return {\"agent\": agent_name, \"error\": str(e)}\n\n# Thread worker\n\
    def worker(queue, results, agent_name, config, mr_details, mr_diff, model):\n\
    \    result = run_agent(agent_name, config, mr_details, mr_diff, model)\n   \
    \ results[agent_name] = result\n\n# Start all agents in parallel\nresults = {}\n\
    threads = []\n\nfor agent_name in agents_config[\"enabled\"]:\n    if agent_name\
    \ in agents_config[\"configs\"]:\n        config = agents_config[\"configs\"\
    ][agent_name]\n        thread = threading.Thread(\n            target=worker,\n\
    \            args=(None, results, agent_name, config, mr_details, mr_diff, inputs.get(\"\
    model\", \"sonnet\"))\n        )\n        thread.start()\n        threads.append(thread)\n\
    \n# Wait for all threads to complete\nfor thread in threads:\n    thread.join()\n\
    \n# Collect results in order\nreviews = []\nfor agent_name in agents_config[\"\
    enabled\"]:\n    if agent_name in results:\n        reviews.append(results[agent_name])\n\
    \nresult = reviews\n"
  output: all_reviews
- name: synthesize_review
  description: Synthesize final personalized review
  compute: |
    import subprocess

    # Collect all review content
    review_content = ""
    has_critical = False
    for r in all_reviews:
        if r and not r.get("error") and r.get("review"):
            review_text = r.get("review", "")
            review_content += f"\n=== {r.get('agent', 'unknown').upper()} REVIEW ===\n{review_text}\n"
            if "[CRITICAL]" in review_text.upper():
                has_critical = True

    prompt_text = f"""You are reviewing MR !{inputs.get('mr_id')} as a senior engineer.

    MR Details:
    {mr_details}

    Specialized Analysis:
    {review_content}

    IMPORTANT - Output format depends on severity:

    **If there are CRITICAL issues:** Provide a detailed review with sections for Critical Issues, Warnings, and Suggestions.

    **If there are NO critical issues (approval case):** Be BRIEF. Use this format:
    ```
    # Approved: MR !<number>

    <1-2 sentence summary of what the MR does and why it's good>

    **Minor notes** (optional, only if genuinely useful):
    - <brief item>
    ```

    Requirements:
    1. Write as a single engineer (use "I" not "we")
    2. NO emojis or icons
    3. NO mention of AI, agents, Claude, Gemini, or automated systems
    4. Sound professional and personable
    5. For approvals: MAX 5-6 lines total. Don't pad with unnecessary praise.
    6. Only mention warnings/suggestions if they're genuinely actionable

    Provide a natural-sounding code review.
    """

    try:
        proc = subprocess.run(
            ["claude", "--model", inputs.get("model", "sonnet")],
            input=prompt_text,
            capture_output=True,
            text=True,
            timeout=300
        )
        result = proc.stdout
    except Exception as e:
        result = f"Error synthesizing review: {str(e)}"
  output: final_review
- name: build_summary
  description: Build summary
  compute: "lines = [\"# Multi-Agent Review\", \"\"]\nfor r in all_reviews:\n    agent\
    \ = r.get(\"agent\", \"unknown\")\n    cli = r.get(\"cli\", \"unknown\")\n   \
    \ error = r.get(\"error\")\n    if error:\n        lines.append(f\"- {agent} ({cli}):\
    \ ERROR - {error}\")\n    else:\n        lines.append(f\"- {agent} ({cli}): OK\"\
    )\n\nresult = \"\\n\".join(lines)\n"
  output: summary
- name: build_review_output
  description: Build review output
  compute: "result = final_review\n"
  output: review
- name: build_stats_output
  description: Build stats output
  compute: "result = {\"agent_count\": len(all_reviews), \"successful\": len([r for\
    \ r in all_reviews if not r.get(\"error\")])}\n"
  output: stats
- name: post_review
  description: Post review to MR
  condition: inputs.get("post_combined", False) and "API Error" not in str(review) and "Error" not in str(review)[:20]
  tool: gitlab_mr_comment
  args:
    project: automation-analytics/automation-analytics-backend
    mr_id: '{{ inputs.mr_id }}'
    message: '{{ review }}'
  on_error: continue
