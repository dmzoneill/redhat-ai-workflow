# Skill: Standup Summary
# Generate standup summary from recent activity

name: standup_summary
description: |
  Generate a standup summary from recent activity:
  - Git commits from yesterday/today
  - Jira issues worked on (In Progress, In Review)
  - MRs created/reviewed
  - Issues closed

  If 'repo' is not provided, can be resolved from 'repo_name' or 'issue_key' via config.

  Perfect for daily standups or status updates.
version: "1.1"

inputs:
  - name: repo
    type: string
    required: false
    default: ""
    description: "Repository path - if not provided, resolved from repo_name or issue_key"

  - name: repo_name
    type: string
    required: false
    description: "Repository name from config (e.g., 'automation-analytics-backend')"

  - name: issue_key
    type: string
    required: false
    description: "Jira issue key - used to resolve repo and Jira project"

  - name: days
    type: integer
    required: false
    default: 1
    description: "How many days back to look (default: 1 for yesterday)"

  - name: include_jira
    type: boolean
    required: false
    default: true
    description: "Include Jira issues"

  - name: include_gitlab
    type: boolean
    required: false
    default: true
    description: "Include GitLab MR activity"

  - name: author
    type: string
    required: false
    description: "Git author email (defaults to git config)"

# jira_url loaded from config.json in load_config step

steps:
  # ==================== RESOLVE REPOSITORY ====================

  - name: resolve_repo
    description: "Determine which repo and GitLab project to use"
    compute: |
      import os
      from scripts.common.config_loader import load_config

      repo_path = None
      gitlab_project = "automation-analytics/automation-analytics-backend"
      jira_project = "AAP"

      # Load config using shared loader
      config = load_config()
      repos = config.get("repositories", {})

      # Explicit repo path
      if inputs.repo and inputs.repo != "" and inputs.repo != ".":
          repo_path = inputs.repo
          for name, cfg in repos.items():
              if cfg.get("path") == repo_path:
                  gitlab_project = cfg.get("gitlab", gitlab_project)
                  jira_project = cfg.get("jira_project", jira_project)
                  break
      # Repo name from config
      elif inputs.repo_name and inputs.repo_name in repos:
          cfg = repos[inputs.repo_name]
          repo_path = cfg.get("path")
          gitlab_project = cfg.get("gitlab", gitlab_project)
          jira_project = cfg.get("jira_project", jira_project)
      # Resolve from issue key
      elif inputs.issue_key:
          project_prefix = inputs.issue_key.split("-")[0].upper()
          jira_project = project_prefix
          for name, cfg in repos.items():
              if cfg.get("jira_project") == project_prefix:
                  repo_path = cfg.get("path")
                  gitlab_project = cfg.get("gitlab", gitlab_project)
                  break
      # Fall back to cwd
      else:
          cwd = os.getcwd()
          if os.path.exists(os.path.join(cwd, ".git")):
              repo_path = cwd
              for name, cfg in repos.items():
                  if cfg.get("path") == cwd:
                      gitlab_project = cfg.get("gitlab", gitlab_project)
                      jira_project = cfg.get("jira_project", jira_project)
                      break

      if not repo_path:
          raise ValueError("Repository not specified. Provide 'repo', 'repo_name', or 'issue_key'.")

      result = {"path": repo_path, "gitlab_project": gitlab_project, "jira_project": jira_project}
    output: resolved_repo

  # ==================== GET AUTHOR ====================

  - name: get_author_email
    description: "Get git author email"
    condition: "not inputs.author"
    tool: git_config_get
    args:
      repo: "{{ resolved_repo.path }}"
      key: "user.email"
    output: author_email_raw
    on_error: continue

  - name: get_author_name
    description: "Get git author name"
    tool: git_config_get
    args:
      repo: "{{ resolved_repo.path }}"
      key: "user.name"
    output: author_name_raw
    on_error: continue

  - name: parse_author
    description: "Parse author info"
    compute: |
      if inputs.author:
        author = inputs.author
      else:
        author = str(author_email_raw).strip() if 'author_email_raw' in dir() and author_email_raw else ""
        # Remove error prefix if present
        if author.startswith("âŒ"):
          author = ""

      name = str(author_name_raw).strip() if 'author_name_raw' in dir() and author_name_raw else ""
      if name.startswith("âŒ"):
        name = ""

      result = {"email": author, "name": name}
    output: author_info

  # ==================== GET COMMITS (using MCP tool) ====================

  - name: get_commit_log
    description: "Get recent commits"
    tool: git_log
    args:
      repo: "{{ resolved_repo.path }}"
      limit: 30
      oneline: true
    output: commit_log_raw
    on_error: continue

  - name: parse_commits
    description: "Parse commit log for standup"
    compute: |
      import sys
      from pathlib import Path

      # Add scripts path for shared parsers
      scripts_path = str(Path(__file__).parent.parent / "scripts") if hasattr(Path(__file__), 'parent') else str(Path.cwd() / "scripts")
      if scripts_path not in sys.path:
          sys.path.insert(0, scripts_path)
      from common.parsers import parse_git_log, extract_jira_key

      # Use shared parser for git log
      commits = parse_git_log(commit_log_raw) if commit_log_raw else []

      # Extract issue keys from commit messages using shared parser
      issue_keys = set()
      for commit in commits:
        key = extract_jira_key(commit.get("message", ""))
        if key:
          issue_keys.add(key.upper())

      result = {
        "commits": commits[:20],
        "count": len(commits),
        "issue_keys": list(issue_keys),
      }
    output: commit_info

  # ==================== GET JIRA ACTIVITY ====================

  - name: get_jira_in_progress
    description: "Get my issues in progress"
    condition: "inputs.include_jira"
    tool: jira_search
    args:
      jql: 'project = {{ resolved_repo.jira_project }} AND assignee = currentUser() AND status in ("In Progress", "In Review") ORDER BY updated DESC'
    output: jira_in_progress
    on_error: continue

  - name: get_jira_done_recently
    description: "Get recently closed issues"
    condition: "inputs.include_jira"
    tool: jira_search
    args:
      jql: 'project = {{ resolved_repo.jira_project }} AND assignee = currentUser() AND status = Done AND updated >= -{{ inputs.days }}d ORDER BY updated DESC'
    output: jira_done
    on_error: continue

  - name: parse_jira_issues
    description: "Parse Jira issues using shared parser"
    condition: "inputs.include_jira"
    compute: |
      from scripts.common.parsers import parse_jira_issues

      # Use shared parser for Jira issues
      in_progress = parse_jira_issues(str(jira_in_progress) if jira_in_progress else "")
      done = parse_jira_issues(str(jira_done) if jira_done else "")

      result = {
          "in_progress": in_progress[:10],
          "done": done[:10],
      }
    output: jira_issues
    on_error: continue

  # ==================== GET GITLAB ACTIVITY ====================

  - name: get_my_mrs
    description: "Get MRs I created"
    condition: "inputs.include_gitlab"
    tool: gitlab_mr_list
    args:
      project: "{{ resolved_repo.gitlab_project }}"
      state: all
      author: "{{ author_info.name }}"
    output: my_mrs_raw
    on_error: continue

  - name: get_mr_reviews
    description: "Get MRs I reviewed"
    condition: "inputs.include_gitlab"
    tool: gitlab_mr_list
    args:
      project: "{{ resolved_repo.gitlab_project }}"
      state: all
      reviewer: "{{ author_info.name }}"
    output: reviewed_mrs_raw
    on_error: continue

  - name: parse_gitlab_activity
    description: "Parse GitLab MR activity using shared parser"
    condition: "inputs.include_gitlab"
    compute: |
      from scripts.common.parsers import parse_mr_list

      # Use shared parser for MR lists
      my_mrs = parse_mr_list(str(my_mrs_raw) if my_mrs_raw else "")
      reviewed = parse_mr_list(str(reviewed_mrs_raw) if reviewed_mrs_raw else "")

      result = {
          "my_mrs": my_mrs[:5],
          "reviewed": reviewed[:5],
      }
    output: gitlab_activity
    on_error: continue

  # ==================== BUILD SUMMARY ====================

  - name: build_summary
    description: "Build standup summary"
    compute: |
      from datetime import datetime

      lines = []
      lines.append(f"## ðŸ“‹ Standup Summary")
      lines.append(f"**Date:** {datetime.now().strftime('%Y-%m-%d')}")
      lines.append(f"**Author:** {author_info.get('name', 'Unknown')}")
      lines.append("")

      # Yesterday / Done
      lines.append("### âœ… What I Did")
      if commit_info.get("commits"):
          lines.append(f"**Commits:** {commit_info['count']}")
          for c in commit_info["commits"][:5]:
              lines.append(f"- `{c['sha']}` {c['message'][:50]}")
          if commit_info["count"] > 5:
              lines.append(f"- ... and {commit_info['count'] - 5} more")
      else:
          lines.append("- No commits in the last day")

      if jira_issues and jira_issues.get("done"):
          lines.append("")
          lines.append("**Issues Closed:**")
          for issue in jira_issues["done"][:5]:
              lines.append(f"- [{issue['key']}] {issue['summary']}")

      if gitlab_activity and gitlab_activity.get("reviewed"):
          lines.append("")
          lines.append("**PRs Reviewed:**")
          for mr in gitlab_activity["reviewed"][:3]:
              lines.append(f"- !{mr['iid']}: {mr['title']}")

      lines.append("")

      # Today / In Progress
      lines.append("### ðŸ”„ What I'm Working On")
      if jira_issues and jira_issues.get("in_progress"):
          for issue in jira_issues["in_progress"][:5]:
              lines.append(f"- [{issue['key']}] {issue['summary']}")
      elif commit_info.get("issue_keys"):
          for key in commit_info["issue_keys"][:5]:
              lines.append(f"- {key}")
      else:
          lines.append("- (Add your current work here)")

      if gitlab_activity and gitlab_activity.get("my_mrs"):
          lines.append("")
          lines.append("**Open MRs:**")
          for mr in gitlab_activity["my_mrs"][:3]:
              lines.append(f"- !{mr['iid']}: {mr['title']}")

      lines.append("")

      # Blockers
      lines.append("### ðŸš§ Blockers")
      lines.append("- None")
      lines.append("")

      lines.append("---")
      lines.append("*Generated by standup_summary skill*")

      result = "\n".join(lines)
    output: standup

  # ==================== MEMORY INTEGRATION ====================

  - name: load_memory
    description: "Load current work state from memory"
    tool: memory_read
    args:
      key: "state/current_work"
    output: memory_state_raw
    on_error: continue

  - name: enhance_with_memory
    description: "Enhance standup with memory context"
    compute: |
      import yaml

      lines = [standup]

      # Parse memory
      memory_state = {}
      if memory_state_raw and isinstance(memory_state_raw, str):
          try:
              memory_state = yaml.safe_load(memory_state_raw) or {}
          except:
              pass

      # Add follow-ups from memory
      follow_ups = memory_state.get("follow_ups", [])
      if follow_ups:
          lines.append("")
          lines.append("### ðŸ“‹ Follow-ups (from memory)")
          for fu in follow_ups[:5]:
              priority = fu.get("priority", "normal")
              emoji = "ðŸ”´" if priority == "high" else "ðŸŸ¡" if priority == "medium" else "âšª"
              lines.append(f"- {emoji} {fu.get('task', 'N/A')}")

      result = "\n".join(lines)
    output: enhanced_standup

  - name: log_standup
    description: "Log standup generation to session"
    tool: memory_session_log
    args:
      action: "Generated standup summary"
      details: "{{ commit_info.count }} commits, {{ jira_issues.in_progress|length if jira_issues and jira_issues.in_progress else 0 }} issues in progress"
    on_error: continue

# ==================== OUTPUT ====================

outputs:
  - name: summary
    value: |
      {{ enhanced_standup }}

  - name: context
    value:
      author: "{{ author_info.name }}"
      repo: "{{ resolved_repo.path }}"
      gitlab_project: "{{ resolved_repo.gitlab_project }}"
      jira_project: "{{ resolved_repo.jira_project }}"
      commits: "{{ commit_info.count }}"
      issue_keys: "{{ commit_info.issue_keys }}"
