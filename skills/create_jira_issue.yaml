# Skill: Create Jira Issue
# Create new Jira issues with linking and assignment

name: create_jira_issue
description: |
  Create a new Jira issue with proper linking and assignment.

  Use for:
  - Creating bug reports
  - Creating feature requests
  - Creating sub-tasks
  - Linking related issues

  The skill will:
  1. Create the issue
  2. Assign to specified user (or self)
  3. Link to related issues
  4. Transition to appropriate status

version: "1.0"

inputs:
  - name: summary
    type: string
    required: true
    description: "Issue summary/title"

  - name: description
    type: string
    required: false
    default: ""
    description: "Issue description (markdown supported)"

  - name: issue_type
    type: string
    required: false
    default: "Task"
    description: "Issue type: 'Bug', 'Task', 'Story', 'Sub-task'"

  - name: project
    type: string
    required: false
    default: "AAP"
    description: "Jira project key"

  - name: assignee
    type: string
    required: false
    description: "Assign to user (leave empty for self)"

  - name: labels
    type: string
    required: false
    description: "Comma-separated labels"

  - name: priority
    type: string
    required: false
    default: "Medium"
    description: "Priority: 'Highest', 'High', 'Medium', 'Low', 'Lowest'"

  - name: link_to
    type: string
    required: false
    description: "Issue key to link to (e.g., AAP-12345)"

  - name: link_type
    type: string
    required: false
    default: "relates to"
    description: "Link type: 'relates to', 'blocks', 'is blocked by', 'duplicates'"

  - name: start_progress
    type: boolean
    required: false
    default: false
    description: "Immediately transition to In Progress"

steps:

  - name: init_autoheal
    description: "Initialize failure tracking"
    compute: |
      result = {"jira_failures": []}
    output: autoheal_state
    on_error: continue

  # ==================== CREATE ISSUE ====================

  - name: create_issue
    description: "Create the Jira issue"
    tool: jira_create_issue
    args:
      project: "{{ inputs.project }}"
      summary: "{{ inputs.summary }}"
      description: "{{ inputs.description or '' }}"
      issue_type: "{{ inputs.issue_type }}"
      priority: "{{ inputs.priority }}"
      labels: "{{ inputs.labels or '' }}"
    output: create_result
    on_error: continue

  - name: parse_create_result
    description: "Parse issue creation result"
    compute: |
      result_text = str(create_result) if create_result else ""

      # Extract issue key
      import re
      issue_key = None
      key_match = re.search(r'([A-Z]+-\d+)', result_text)
      if key_match:
          issue_key = key_match.group(1)

      success = issue_key is not None or ("created" in result_text.lower() and "error" not in result_text.lower())

      result = {
          "success": success,
          "issue_key": issue_key,
          "message": result_text[:300] if result_text else "No response",
      }
    output: create_status

  # ==================== ASSIGN ISSUE ====================

  - name: assign_issue
    description: "Assign the issue"
    condition: "create_status.issue_key"
    tool: jira_assign
    args:
      issue_key: "{{ create_status.issue_key }}"
      assignee: "{{ inputs.assignee or 'currentUser' }}"
    output: assign_result
    on_error: continue

  # ==================== LINK ISSUES ====================

  - name: link_issues
    description: "Link to related issue"
    condition: "create_status.issue_key and inputs.link_to"
    tool: jira_link_issues
    args:
      inward_issue: "{{ create_status.issue_key }}"
      outward_issue: "{{ inputs.link_to }}"
      link_type: "{{ inputs.link_type }}"
    output: link_result
    on_error: continue

  - name: parse_link
    description: "Parse link result"
    condition: "link_result"
    compute: |
      link_text = str(link_result) if link_result else ""

      success = "error" not in link_text.lower()

      result = {
          "success": success,
          "message": link_text[:200] if link_text else "Unknown",
      }
    output: link_status
    on_error: continue

  # ==================== UPDATE ISSUE (add more fields) ====================

  - name: update_issue
    description: "Update issue with additional fields"
    condition: "create_status.issue_key and inputs.labels"
    tool: jira_update_issue
    args:
      issue_key: "{{ create_status.issue_key }}"
      fields: "labels"
      values: "{{ inputs.labels }}"
    output: update_result
    on_error: continue

  # ==================== TRANSITION ====================

  - name: transition_to_progress
    description: "Transition to In Progress"
    condition: "create_status.issue_key and inputs.start_progress"
    tool: jira_transition
    args:
      issue_key: "{{ create_status.issue_key }}"
      transition: "Start Progress"
    output: transition_result
    on_error: continue

  # ==================== GET FINAL STATE ====================

  - name: get_issue
    description: "Get the created issue details"
    condition: "create_status.issue_key"
    tool: jira_view_issue
    args:
      issue_key: "{{ create_status.issue_key }}"
    output: issue_details
    on_error: continue

  # ==================== MEMORY ====================

  - name: log_creation
    description: "Log issue creation"
    condition: "create_status.success"
    tool: memory_session_log
    args:
      action: "Created Jira issue {{ create_status.issue_key }}"
      details: "{{ inputs.summary[:50] }}{% if inputs.link_to %}, linked to {{ inputs.link_to }}{% endif %}"
    on_error: continue

outputs:
  - name: report
    value: |
      ## üé´ Create Jira Issue

      {% if create_status.success %}
      ### ‚úÖ Issue Created

      **Key:** [{{ create_status.issue_key }}](https://issues.redhat.com/browse/{{ create_status.issue_key }})
      **Summary:** {{ inputs.summary }}
      **Type:** {{ inputs.issue_type }}
      **Priority:** {{ inputs.priority }}

      {% if assign_result %}
      **Assigned to:** {{ inputs.assignee or "you" }}
      {% endif %}

      {% if link_status and link_status.success %}
      **Linked to:** [{{ inputs.link_to }}](https://issues.redhat.com/browse/{{ inputs.link_to }}) ({{ inputs.link_type }})
      {% elif inputs.link_to and not link_status.success %}
      ‚ö†Ô∏è Link to {{ inputs.link_to }} failed: {{ link_status.message }}
      {% endif %}

      {% if inputs.start_progress %}
      **Status:** In Progress
      {% endif %}

      ---

      ### Next Steps

      **View issue:**
      ```python
      jira_view_issue(issue_key='{{ create_status.issue_key }}')
      ```

      **Start working:**
      ```python
      skill_run("start_work", '{"issue_key": "{{ create_status.issue_key }}"}')
      ```

      **Add comment:**
      ```python
      jira_add_comment(issue_key='{{ create_status.issue_key }}', comment='...')
      ```

      {% else %}
      ### ‚ùå Creation Failed

      {{ create_status.message }}

      Check:
      - Project key is valid ({{ inputs.project }})
      - Issue type exists ({{ inputs.issue_type }})
      - You have permission to create issues

      {% endif %}

  - name: context
    value:
      issue_key: "{{ create_status.issue_key }}"
      created: "{{ create_status.success }}"
      linked: "{{ link_status.success if link_status else false }}"
      link_to: "{{ inputs.link_to }}"
