# Skill: Notify Team About MR
# Posts a review request to the team Slack channel for an existing MR

name: notify_mr
description: |
  Notify the team Slack channel about an existing MR that's ready for review.

  Use this when:
  - You created a draft MR and it's now ready
  - You want to remind the team about a pending review
  - You marked an MR as ready after initial work

  Uses MCP tools: gitlab_mr_view, jira_view_issue, slack_post_team

version: "1.0"

inputs:
  - name: mr_id
    type: string
    required: false
    description: "GitLab MR IID (e.g., 1459). If not provided, will try to find from current branch."

  - name: project
    type: string
    required: false
    default: ""
    description: "GitLab project path (e.g., 'automation-analytics/automation-analytics-backend')"

  - name: issue_key
    type: string
    required: false
    default: ""
    description: "Jira issue key for additional context"

  - name: message
    type: string
    required: false
    default: ""
    description: "Custom message to include (optional)"

  - name: reminder
    type: boolean
    required: false
    default: false
    description: "If true, formats as a reminder rather than new MR notification"

steps:
  # ==================== SETUP ====================

  - name: setup
    description: "Load configuration and resolve inputs"
    compute: |
      from scripts.common.config_loader import load_config
      import subprocess
      import os

      config = load_config()

      jira_url = config.get("jira", {}).get("url", "https://issues.redhat.com")
      gitlab_url = config.get("gitlab", {}).get("url", "https://gitlab.cee.redhat.com")

      # Get team group info for @mentions
      team_channel = config.get("slack", {}).get("channels", {}).get("team", {})
      team_group_id = team_channel.get("group_id", "")
      team_group_handle = team_channel.get("group_handle", "aa-api-team")

      # Resolve project - use input or find default from config
      project = inputs.get("project", "")
      if not project:
          repos = config.get("repositories", {})
          for name, cfg in repos.items():
              if cfg.get("gitlab"):
                  project = cfg.get("gitlab")
                  break

      # Resolve MR ID - use input or try to find from branch
      mr_id = inputs.get("mr_id", "")
      if not mr_id:
          # Try to get from current branch
          try:
              result_branch = subprocess.run(
                  ["git", "branch", "--show-current"],
                  capture_output=True, text=True, cwd=os.getcwd()
              )
              if result_branch.returncode == 0:
                  branch = result_branch.stdout.strip()
                  # Would need to call gitlab_mr_list here, but for now require mr_id
                  pass
          except Exception:
              pass

      if not mr_id:
          raise ValueError("mr_id is required. Please provide the MR IID.")

      result = {
          "jira_url": jira_url,
          "gitlab_url": gitlab_url,
          "project": project,
          "mr_id": str(mr_id),
          "issue_key": inputs.get("issue_key", "").upper() if inputs.get("issue_key") else "",
          "custom_message": inputs.get("message", ""),
          "is_reminder": inputs.get("reminder", False),
          "team_group_id": team_group_id,
          "team_group_handle": team_group_handle,
      }
    output: ctx

  # ==================== FETCH MR DETAILS ====================

  - name: get_mr_details
    description: "Get MR details from GitLab"
    tool: gitlab_mr_view
    args:
      project: "{{ ctx.project }}"
      mr_id: "{{ ctx.mr_id }}"
    output: mr_result
    on_error: continue

  - name: parse_mr_result
    description: "Parse MR details from glab output"
    compute: |
      mr_text = str(mr_result) if mr_result else ""

      # Parse the glab output
      title = ""
      web_url = ""

      for line in mr_text.split("\n"):
          if line.startswith("title:"):
              title = line.replace("title:", "").strip()
          elif line.startswith("url:"):
              web_url = line.replace("url:", "").strip()

      # If no URL found, construct it
      if not web_url:
          web_url = f"{ctx.get('gitlab_url')}/{ctx.get('project')}/-/merge_requests/{ctx.get('mr_id')}"

      # Extract issue key from title if not provided
      issue_key = ctx.get("issue_key", "")
      if not issue_key:
          import re
          match = re.search(r"(AAP-\d+|ANSTRAT-\d+|AA-\d+)", title, re.IGNORECASE)
          if match:
              issue_key = match.group(1).upper()

      result = {
          "title": title or "Merge Request",
          "web_url": web_url,
          "issue_key": issue_key,
      }
    output: mr

  # ==================== FETCH JIRA DETAILS ====================

  - name: get_jira_details
    description: "Get Jira issue details for context"
    condition: "mr.get('issue_key')"
    tool: jira_view_issue
    args:
      issue_key: "{{ mr.issue_key }}"
    output: jira_result
    on_error: continue

  - name: parse_jira_result
    description: "Parse Jira issue summary"
    compute: |
      jira_text = str(jira_result) if jira_result else ""
      summary = ""

      # Look for summary line
      for line in jira_text.split("\n"):
          if line.startswith("summary"):
              parts = line.split(":", 1)
              if len(parts) > 1:
                  summary = parts[1].strip()[:80]
                  break

      result = {"summary": summary}
    output: jira

  # ==================== POST NOTIFICATION ====================

  - name: build_and_post
    description: "Build Slack message and post to team channel"
    compute: |
      import subprocess
      import os

      jira_url = ctx.get("jira_url", "https://issues.redhat.com")
      issue_key = mr.get("issue_key", "")
      jira_summary = jira.get("summary", "") if jira else ""
      mr_id = ctx.get("mr_id", "")
      mr_title = mr.get("title", "Merge Request")
      mr_web_url = mr.get("web_url", "")
      custom_message = ctx.get("custom_message", "")
      is_reminder = ctx.get("is_reminder", False)

      # Build team mention using group ID from config
      team_group_id = ctx.get("team_group_id", "")
      team_group_handle = ctx.get("team_group_handle", "aa-api-team")
      if team_group_id:
          team_mention = f"<!subteam^{team_group_id}|@{team_group_handle}>"
      else:
          team_mention = f"@{team_group_handle}"

      # Build message
      lines = [team_mention]

      if is_reminder:
          lines.append("‚è∞ *Reminder - Please review:*")
      else:
          lines.append("üîÄ *Please review:*")

      lines.append("")

      # Jira issue as hyperlink (if available)
      if issue_key:
          jira_text = f"{issue_key}: {jira_summary}" if jira_summary else issue_key
          lines.append(f"‚Ä¢ <{jira_url}/browse/{issue_key}|{jira_text}>")

      # MR as hyperlink (ID and title)
      mr_link_text = f"!{mr_id}: {mr_title[:80]}"
      lines.append(f"‚Ä¢ <{mr_web_url}|{mr_link_text}>")

      # Custom message if provided
      if custom_message:
          lines.append("")
          lines.append(custom_message)

      slack_message = "\n".join(lines)

      # For now, store the message - actual posting needs the slack module loaded
      result = {
          "message": slack_message,
          "issue_key": issue_key,
          "mr_id": mr_id,
          "mr_url": mr_web_url,
      }
    output: notification

  - name: post_to_team
    description: "Post notification to team channel"
    tool: slack_post_team
    args:
      text: "{{ notification.message }}"
    output: slack_result
    on_error: continue

  # ==================== MEMORY INTEGRATION ====================

  - name: log_notification
    description: "Log notification to session"
    tool: memory_session_log
    args:
      action: "Notified team about MR !{{ notification.mr_id }}"
      details: "{{ 'Reminder' if inputs.reminder else 'New notification' }}, Jira: {{ notification.issue_key }}"
    on_error: continue

outputs:
  - name: summary
    value: |
      ## {{ "‚úÖ Team Notified" if slack_result else "üìã Message Ready" }}

      **MR:** !{{ notification.mr_id }}
      **URL:** {{ notification.mr_url }}
      {% if notification.issue_key %}
      **Jira:** {{ notification.issue_key }}
      {% endif %}

      {% if slack_result %}
      üì¢ Review request posted to team channel
      {% else %}
      ‚ö†Ô∏è Message built but Slack posting requires slack module to be loaded
      {% endif %}

  - name: message
    value: "{{ notification.message }}"

  - name: context
    value:
      mr_id: "{{ notification.mr_id }}"
      issue_key: "{{ notification.issue_key }}"
      posted: "{{ 'true' if slack_result else 'false' }}"
