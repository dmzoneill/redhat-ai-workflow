# Skill: Check Secrets
# Verify secrets and configmaps are properly configured

name: check_secrets
description: |
  Check secrets and configmaps in a namespace.

  Useful for:
  - Verifying deployment configuration
  - Debugging missing env vars
  - Auditing secret presence

  Uses: kubectl_get_secrets, kubectl_get_configmaps, kubectl_describe_deployment
version: "1.0"

inputs:
  - name: namespace
    type: string
    required: true
    description: "Kubernetes namespace"

  - name: environment
    type: string
    required: false
    default: "stage"
    description: "Environment (stage, production, ephemeral)"

  - name: deployment
    type: string
    required: false
    default: ""
    description: "Optional: specific deployment to check references"

steps:
  - name: get_secrets
    description: "List secrets in namespace"
    tool: kubectl_get_secrets
    args:
      namespace: "{{ inputs.namespace }}"
      environment: "{{ inputs.environment }}"
    output: secrets_raw
    on_error: continue

  - name: parse_secrets
    description: "Parse secrets list"
    compute: |
      secrets_text = str(secrets_raw) if 'secrets_raw' in dir() and secrets_raw else ""

      secrets = []
      for line in secrets_text.split("\n"):
        parts = line.split()
        if len(parts) >= 2 and parts[0] != "NAME":
          secrets.append({
            "name": parts[0],
            "type": parts[1] if len(parts) > 1 else "unknown",
          })

      result = {
        "secrets": secrets,
        "count": len(secrets),
      }
    output: secrets_info

  - name: get_configmaps
    description: "List configmaps in namespace"
    tool: kubectl_get_configmaps
    args:
      namespace: "{{ inputs.namespace }}"
      environment: "{{ inputs.environment }}"
    output: configmaps_raw
    on_error: continue

  - name: parse_configmaps
    description: "Parse configmaps list"
    compute: |
      cm_text = str(configmaps_raw) if 'configmaps_raw' in dir() and configmaps_raw else ""

      configmaps = []
      for line in cm_text.split("\n"):
        parts = line.split()
        if len(parts) >= 1 and parts[0] != "NAME":
          configmaps.append(parts[0])

      result = {
        "configmaps": configmaps,
        "count": len(configmaps),
      }
    output: configmaps_info

  - name: describe_deployment
    description: "Get deployment to check secret/configmap references"
    condition: "inputs.deployment"
    tool: kubectl_describe_deployment
    args:
      deployment: "{{ inputs.deployment }}"
      namespace: "{{ inputs.namespace }}"
      environment: "{{ inputs.environment }}"
    output: deploy_desc_raw
    on_error: continue

  - name: check_references
    description: "Check if deployment references existing secrets/configmaps"
    condition: "inputs.deployment and deploy_desc_raw"
    compute: |
      deploy_text = str(deploy_desc_raw) if 'deploy_desc_raw' in dir() else ""

      import re

      # Find secretKeyRef and configMapKeyRef
      secret_refs = re.findall(r'secretKeyRef:\s*\n\s*name:\s*(\S+)', deploy_text)
      cm_refs = re.findall(r'configMapKeyRef:\s*\n\s*name:\s*(\S+)', deploy_text)

      # Also find secretRef and configMapRef
      secret_refs += re.findall(r'secretRef:\s*\n\s*name:\s*(\S+)', deploy_text)
      cm_refs += re.findall(r'configMapRef:\s*\n\s*name:\s*(\S+)', deploy_text)

      # Check if referenced secrets/configmaps exist
      existing_secrets = [s["name"] for s in secrets_info.get("secrets", [])]
      existing_cms = configmaps_info.get("configmaps", [])

      missing_secrets = [s for s in set(secret_refs) if s not in existing_secrets]
      missing_cms = [c for c in set(cm_refs) if c not in existing_cms]

      result = {
        "secret_refs": list(set(secret_refs)),
        "configmap_refs": list(set(cm_refs)),
        "missing_secrets": missing_secrets,
        "missing_configmaps": missing_cms,
        "all_present": len(missing_secrets) == 0 and len(missing_cms) == 0,
      }
    output: ref_check

outputs:
  - name: report
    value: |
      ## üîê Secrets & ConfigMaps: {{ inputs.namespace }}

      **Environment:** {{ inputs.environment }}

      ---

      ### Secrets ({{ secrets_info.count }})

      {% for secret in secrets_info.secrets[:15] %}
      - `{{ secret.name }}` ({{ secret.type }})
      {% endfor %}
      {% if secrets_info.count > 15 %}
      ... and {{ secrets_info.count - 15 }} more
      {% endif %}

      ---

      ### ConfigMaps ({{ configmaps_info.count }})

      {% for cm in configmaps_info.configmaps[:15] %}
      - `{{ cm }}`
      {% endfor %}
      {% if configmaps_info.count > 15 %}
      ... and {{ configmaps_info.count - 15 }} more
      {% endif %}

      {% if inputs.deployment %}
      ---

      ### Deployment References: {{ inputs.deployment }}

      **Secrets referenced:** {{ ref_check.secret_refs | length }}
      {% for s in ref_check.secret_refs %}
      - `{{ s }}`
      {% endfor %}

      **ConfigMaps referenced:** {{ ref_check.configmap_refs | length }}
      {% for c in ref_check.configmap_refs %}
      - `{{ c }}`
      {% endfor %}

      {% if ref_check.all_present %}
      ‚úÖ All referenced secrets and configmaps exist
      {% else %}
      ‚ö†Ô∏è **Missing resources:**
      {% for s in ref_check.missing_secrets %}
      - Secret: `{{ s }}` ‚ùå
      {% endfor %}
      {% for c in ref_check.missing_configmaps %}
      - ConfigMap: `{{ c }}` ‚ùå
      {% endfor %}
      {% endif %}
      {% endif %}
