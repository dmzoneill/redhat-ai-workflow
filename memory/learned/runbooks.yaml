# Learned Runbooks
# Operational procedures that have worked

last_updated: null

# Runbooks for common operations
runbooks:
  restart_pod:
    name: "Restart a problematic pod"
    when: "Pod is stuck, OOMKilled, or needs fresh state"
    steps:
      - "kubectl delete pod <pod-name> -n <namespace>"
      - "Wait for new pod to be Ready"
      - "Verify with: kubectl get pods -n <namespace>"
    tools:
      - kubectl_delete_pod
      - kubectl_get_pods

  rollback_deployment:
    name: "Rollback a failed deployment"
    when: "New deployment causing issues"
    steps:
      - "Check deployment history: kubectl rollout history deployment/<name>"
      - "Rollback: kubectl rollout undo deployment/<name>"
      - "Verify pods are healthy"
    tools:
      - kubectl_rollout_history
      - kubectl_rollout_restart

  investigate_alert:
    name: "Systematic alert investigation"
    when: "Alert is firing"
    steps:
      - "Check alert details in Alertmanager"
      - "Query Prometheus for related metrics"
      - "Check pod status and events"
      - "Search Kibana for recent errors"
      - "Check recent deployments"
    tools:
      - alertmanager_alerts
      - prometheus_query
      - kubectl_get_pods
      - kibana_search_logs

  deploy_to_stage:
    name: "Deploy to stage environment"
    when: "MR merged, need to deploy"
    steps:
      - "Verify image exists in Quay"
      - "Check current stage health"
      - "Update App-Interface config"
      - "Monitor rollout"
      - "Verify health after deploy"
    notes: |
      App-Interface deployments are GitOps-based.
      Changes to saas files trigger deployment pipelines.

  hotfix_production:
    name: "Emergency production fix"
    when: "Critical production issue requiring immediate fix"
    steps:
      - "Create hotfix branch from production tag"
      - "Apply minimal fix"
      - "Fast-track MR with URGENT label"
      - "Deploy to stage for quick validation"
      - "Deploy to production"
      - "Monitor closely for 30 minutes"
    notes: |
      Follow incident process. Get approval from on-call.
      Log all actions with memory_session_log().

  test_mr_ephemeral:
    name: "Test MR in ephemeral environment"
    when: "Need to test changes before merge"
    steps:
      - "Wait for Konflux build to complete"
      - "Use skill: skill_run('test_mr_ephemeral', '{\"mr_id\": 123}')"
      - "Run integration tests in namespace"
      - "Verify functionality manually if needed"
      - "Release namespace when done"
    tools:
      - test_mr_ephemeral skill
      - bonfire_namespace_list
      - bonfire_namespace_release
    notes: |
      Image tags must be FULL 40-char SHA, not short SHA.
      Check Quay for image before deploying.

  fix_imagepullbackoff:
    name: "Fix ImagePullBackOff error"
    when: "Pods stuck in ImagePullBackOff"
    steps:
      - "Check image exists: quay_check_image_exists"
      - "Verify image tag is correct (40-char SHA)"
      - "Check pull secret: kubectl get secret -n <namespace>"
      - "If image missing, wait for Konflux build or fix tag"
    tools:
      - quay_check_image_exists
      - kubectl_describe_pod
      - kubectl_get_events

  silence_flaky_alert:
    name: "Silence a flaky alert temporarily"
    when: "Alert is known issue or being investigated"
    steps:
      - "Identify alert name and labels"
      - "Create silence for 2-4 hours"
      - "Create Jira issue to fix underlying cause"
      - "Set reminder to check before silence expires"
    tools:
      - alertmanager_create_silence
      - jira_create_issue
    notes: |
      Always create a Jira issue for silenced alerts.
      Never silence for more than 24 hours without approval.

  refresh_cluster_auth:
    name: "Refresh Kubernetes cluster authentication"
    when: "Commands fail with Unauthorized or token expired"
    steps:
      - "Ephemeral: kube-clean e && kube e"
      - "Stage: kube-clean s && kube s"
      - "Production: kube-clean p && kube p"
      - "Or use: kube_login(cluster='e')"
    notes: |
      Browser will open for SSO authentication.
      Config files: ~/.kube/config.e, config.s, config.p

# Team preferences
preferences:
  commit_format: "{issue_key} - {type}({scope}): {description}"  # From config.json
  branch_format: "aap-xxxxx-short-description"
  mr_description: |
    Include:
    - Jira link
    - Summary of changes
    - Testing done
    - Checklist
